<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEST DATA! Uintah Basin Winter Ozone Information</title>
    
    <!-- Use PNG as favicon (browsers will accept it) -->
    <link rel="icon" type="image/png" href="/public/images/BRS_01_UStateLeft_White.png">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- CSS -->
    <link rel="stylesheet" href="/public/css/main.css">
    <link rel="stylesheet" href="/public/css/index.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body data-page-type="index">
<!-- Colored Bar -->
<div class="colored-bar"></div>

<!-- Sidebar Container -->
<div class="sidebar_container">
    <!-- Sidebar will be loaded here via loadSidebar.js -->
</div>

<!-- Main Content -->
<main class="content">
    <div class="homepage-header">
        <h1 class="site-title">basinwx.com</h1>
        <p class="site-subtitle">Live air quality and weather for the Uintah Basin</p>
    </div>

    <!-- Air Quality Overview Dashboard -->
    <section class="dashboard-section" aria-label="Air Quality and Weather Overview">
        <div class="section-header">
            <h2><i class="fas fa-tachometer-alt"></i> Air Quality and Weather Overview</h2>
        </div>

        <div class="dashboard-grid">
            <!-- Live Map Panel -->
            <div class="dashboard-panel map-panel">
                <div class="panel-header">
                    <h3><i class="fas fa-map-marked-alt"></i> Live Monitoring Stations</h3>
                    <a href="/live_aq" class="panel-link">
                        <i class="fas fa-external-link-alt"></i> Full Map
                    </a>
                </div>
                <div class="map-container-dashboard">
                    <div id="map" class="dashboard-map" aria-label="Air Quality Monitoring Map"></div>
                    <div class="kiosk-switch-container">
                        <label for="kiosk-switch">Auto-cycle stations:</label>
                        <div class="kiosk-switch" id="kiosk-switch" title="Automatically cycle through station popups">
                            <div class="switch-slider"></div>
                        </div>
                        
                        <label for="temp-toggle">Temperature:</label>
                        <div class="temp-toggle" id="temp-toggle" title="Toggle between Celsius and Fahrenheit">
                            <div class="temp-slider"></div>
                            <span class="temp-label" id="temp-label">°F</span>
                        </div>
                    </div>
                </div>
                
                <!-- Compact Legend -->
                <div class="map-legend-compact">
                    <button class="legend-toggle" id="legend-toggle" title="Click to show/hide marker color legend">
                        <i class="fas fa-palette"></i>
                        <span class="legend-toggle-text">Legend</span>
                    </button>
                    <div class="legend-dropdown" id="legend-dropdown">
                        <div class="legend-items-compact">
                            <div class="legend-section-header">Air Quality Stations (●)</div>
                            <div class="legend-row">
                                <div class="legend-color" style="background-color: green;"></div>
                                <span>Good (&lt;50)</span>
                                <div class="legend-color" style="background-color: orange;"></div>
                                <span>Warning (50-69)</span>
                            </div>
                            <div class="legend-row">
                                <div class="legend-color" style="background-color: red;"></div>
                                <span>Danger (≥70)</span>
                                <div class="legend-color" style="background-color: #B8D4E3;"></div>
                                <span>Weather Only</span>
                            </div>
                            <div class="legend-row">
                                <div class="legend-color" style="background-color: gray;"></div>
                                <span>No Data</span>
                            </div>
                            <div class="legend-section-header">Road Weather Stations (♦)</div>
                            <div class="legend-row">
                                <div class="legend-color legend-diamond" style="background-color: #28A745;"></div>
                                <span>No Snow</span>
                                <div class="legend-color legend-diamond" style="background-color: #4A90E2;"></div>
                                <span>Snow Likely</span>
                            </div>
                            <div class="legend-row">
                                <div class="legend-color legend-diamond" style="background-color: gray;"></div>
                                <span>No Data</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Latest Forecast Panel -->
            <div class="dashboard-panel forecast-panel">
                <div class="panel-header">
                    <h3><i class="fas fa-crystal-ball"></i> Latest Forecasts</h3>
                    <button class="forecast-collapse-toggle" id="forecast-collapse" title="Show/hide forecast details">
                        <i class="fas fa-chevron-up"></i>
                    </button>
                    <div class="forecast-tabs">
                        <button class="forecast-tab active" data-tab="air-quality" title="Air quality and ozone outlook">
                            <i class="fas fa-lungs"></i> Air Quality
                        </button>
                        <button class="forecast-tab" data-tab="weather" title="General weather forecast summary">
                            <i class="fas fa-cloud-sun"></i> Weather
                        </button>
                    </div>
                </div>
                <div class="forecast-container-dashboard">
                    <div class="forecast-content active" id="air-quality-content">
                        <div class="outlook-preview-date" id="outlook-date">Loading...</div>
                        <div class="outlook-preview-content compact" id="outlook-summary">Loading air quality outlook...</div>
                        <div class="forecast-link">
                            <a href="/forecast_outlooks" id="aq-see-more">
                                <i class="fas fa-external-link-alt"></i> All Air Quality Outlooks
                            </a>
                        </div>
                    </div>
                    <div class="forecast-content" id="weather-content">
                        <div class="outlook-preview-date">Latest Weather Summary</div>
                        <div class="outlook-preview-content compact" id="weather-summary">Loading weather forecast summary...</div>
                        <div class="forecast-link">
                            <a href="/forecast_weather">
                                <i class="fas fa-external-link-alt"></i> Full Weather Forecasts
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Future sections for weather, alerts, etc. -->
    <!--
    <section class="dashboard-section" aria-label="Weather Overview">
        <div class="section-header">
            <h2><i class="fas fa-cloud-sun"></i> Weather Conditions</h2>
            <div class="section-subtitle">Current conditions and short-term forecasts</div>
        </div>
        <div class="dashboard-grid">
            // Weather content will go here
        </div>
    </section>
    -->
</main>

<!-- Load Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Load JavaScript Modules -->
<script type="module" src="/public/js/loadSidebar.js"></script>
<script src="/public/js/nineties-mode.js"></script>
<script src="/public/js/mobile-menu.js"></script>
<script type="module" src="/public/js/config.js"></script>
<script type="module" src="/public/js/index_map.js"></script>

<!-- Load markdown-it for homepage preview -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/13.0.1/markdown-it.min.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", async function() {
        // Initialize forecast tabs
        initForecastTabs();
        
        // Initialize legend toggle
        initLegendToggle();
        
        // Initialize forecast collapse toggle
        initForecastCollapse();

        // Load initial content
        loadAirQualityForecast();
        loadWeatherForecast();
    });

    function initForecastTabs() {
        const tabs = document.querySelectorAll('.forecast-tab');
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const targetTab = tab.dataset.tab;
                
                // Update tab styles
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Update content visibility
                document.querySelectorAll('.forecast-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`${targetTab}-content`).classList.add('active');
            });
        });
    }

    function initLegendToggle() {
        const toggle = document.getElementById('legend-toggle');
        const dropdown = document.getElementById('legend-dropdown');
        
        if (toggle && dropdown) {
            toggle.addEventListener('click', () => {
                dropdown.classList.toggle('active');
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!toggle.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.remove('active');
                }
            });
        }
    }

    async function loadAirQualityForecast() {
        const outlookSummary = document.getElementById("outlook-summary");
        const seeMoreLink = document.getElementById("aq-see-more");

        if (!outlookSummary) return;

        // Initialize markdown renderer
        const md = markdownit({
            html: true,
            linkify: true,
            typographer: true
        });

        try {
            // Fetch the list of outlooks
            const response = await fetch('/api/static/outlooks/outlooks_list.json');
            if (!response.ok) throw new Error(`HTTP error: ${response.status}`);

            const outlooks = await response.json();

            if (outlooks.length === 0) {
                outlookSummary.textContent = "No recent air quality outlook available.";
                return;
            }

            // Get the latest outlook
            const latestOutlook = outlooks[0];

            // Fetch its content
            const outlookResponse = await fetch(`/api/static/outlooks/${latestOutlook.filename}`);
            if (!outlookResponse.ok) throw new Error(`Failed to load outlook: ${outlookResponse.status}`);

            const markdownContent = await outlookResponse.text();

            // Extract and render preview (more lines, smaller font)
            const previewLines = markdownContent.split('\n')
                .filter(line => line.trim() !== '')
                .slice(0, 8)
                .join('\n');

            // Render markdown to HTML
            outlookSummary.innerHTML = md.render(previewLines);

            // Update the "See more" link
            if (seeMoreLink) {
                seeMoreLink.href = `/forecast_outlooks?file=${latestOutlook.filename}`;
            }

        } catch (error) {
            console.error("Error loading air quality outlook:", error);
            outlookSummary.textContent = "Unable to load the latest air quality outlook.";
        }
    }

    async function loadWeatherForecast() {
        const weatherSummary = document.getElementById("weather-summary");
        if (!weatherSummary) return;

        // Placeholder content - in future this would fetch from weather forecast API
        weatherSummary.innerHTML = `
            <div style="font-style: italic; color: var(--usu-accent); margin-bottom: 0.5rem;">
                General Weather Summary (Placeholder)
            </div>
            <p><strong>Today:</strong> Partly cloudy with light winds. High around 45°F, low near 28°F.</p>
            <p><strong>Tomorrow:</strong> Mostly sunny conditions expected. Temperatures rising to 52°F during the day.</p>
            <p><strong>Weekend:</strong> Stable weather pattern continues with clear skies and moderate temperatures.</p>
            <p><strong>Air Quality Impact:</strong> Light winds may contribute to pollutant accumulation in valleys during morning hours.</p>
            <div style="font-size: 0.8rem; font-style: italic; color: var(--usu-accent); margin-top: 0.5rem;">
                Note: This is placeholder content. Future implementation will pull from LLM-generated weather summaries.
            </div>
        `;
    }
    
    function initForecastCollapse() {
        const collapseBtn = document.getElementById('forecast-collapse');
        const forecastContainer = document.querySelector('.forecast-container-dashboard');
        
        if (collapseBtn && forecastContainer) {
            collapseBtn.addEventListener('click', () => {
                const isCollapsed = collapseBtn.classList.contains('collapsed');
                
                if (isCollapsed) {
                    // Expand
                    collapseBtn.classList.remove('collapsed');
                    forecastContainer.classList.remove('collapsed');
                } else {
                    // Collapse
                    collapseBtn.classList.add('collapsed');
                    forecastContainer.classList.add('collapsed');
                }
            });
        }
    }
</script>

<!-- Easter Eggs - Activated via Konami Code -->
<link rel="stylesheet" href="/public/css/easter-eggs.css">
<script src="/public/js/easter-eggs.js"></script>

</body>
</html>